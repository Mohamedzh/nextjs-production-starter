# Next.js Production Starter - Cursor Rules

## Project Type
Next.js 16.1.1 + TypeScript + Prisma 7 + NextAuth v4 + Redis + Tailwind v4 + Railway (Railpack)

## Core Principle
**PostgreSQL and Redis are always required.** Auth and OAuth providers are optional.

## Feature Detection Pattern
```typescript
import { features } from '@/lib/features';

// Only check for OPTIONAL features (auth & OAuth)
if (features.auth) { /* NextAuth code */ }
if (features.githubProvider) { /* GitHub OAuth */ }

// Database and Redis are ALWAYS available - no checks needed
import { db } from '@/lib/db';
const users = await db.user.findMany();
```

## Critical Rules

1. **Check `features.*` only for auth and OAuth** - database/redis always available
2. **Import `db` directly from '@/lib/db'** - always initialized
3. **Use `env.*` not `process.env.*`** - type-safe with Zod validation
4. **Use `logger.*` not `console.*`** - structured JSON logging
5. **DATABASE_URL and REDIS_URL are required** - validated at startup

## Code Patterns

### API Route
```typescript
import { NextRequest, NextResponse } from 'next/server';
import logger from '@/lib/logger';

export async function GET(request: NextRequest) {
  try {
    logger.info('Processing request');
    return NextResponse.json({ success: true });
  } catch (error) {
    logger.error({ error }, 'Failed');
    return NextResponse.json({ error: 'Error' }, { status: 500 });
  }
}
```

### Database Query
```typescript
import { db } from '@/lib/db';

// Database is always available - no null checks needed
const data = await db.model.findMany();
```

### Protected Route
```typescript
import { auth } from '@/lib/auth';
import { features } from '@/lib/features';
import { redirect } from 'next/navigation';

if (!features.auth) redirect('/?error=auth-disabled');
const session = await auth();
if (!session) redirect('/signin');
```

### Conditional OAuth
```typescript
import { features } from '@/lib/features';

{features.githubProvider && <GitHubButton />}
{features.googleProvider && <GoogleButton />}
```

## File Structure

- `lib/features.ts` → Feature detection (CHECK FIRST)
- `lib/env.ts` → Type-safe environment variables
- `lib/logger.ts` → Structured logging (Pino)
- `lib/db.ts` → Conditional Prisma client
- `lib/auth/` → NextAuth configuration

## Environment Variables

**Required:**
- `DATABASE_URL` → PostgreSQL connection (REQUIRED)
- `REDIS_URL` → Redis connection (REQUIRED)

**Optional:**
- `NEXTAUTH_SECRET` → Enables authentication
- `GITHUB_ID` + `GITHUB_SECRET` → GitHub OAuth
- `GOOGLE_ID` + `GOOGLE_SECRET` → Google OAuth
- `DISCORD_ID` + `DISCORD_SECRET` → Discord OAuth
- `CRON_SECRET` → Secures cron endpoints

## Important Patterns

### SessionProvider (Client Component)
```typescript
// Only render when auth is enabled
{features.auth ? (
  <SessionProvider>{children}</SessionProvider>
) : children}
```

### NextAuth v4 (Not v5)
- Use `NextAuthOptions` type
- Use `getServerSession(authConfig)` for server-side
- Use `useSession()` from 'next-auth/react' for client-side

## Testing Checklist

Test with these configurations:
1. Minimal (DATABASE_URL + REDIS_URL only) → Auth disabled
2. With auth (+ NEXTAUTH_SECRET) → Auth works
3. Full stack (+ all OAuth vars) → All features work

**DATABASE_URL and REDIS_URL are required for build.**

## Anti-Patterns

- ❌ Check `features.database` or `features.redis` (they don't exist)
- ❌ Use `console.log()` in production code
- ❌ Access `process.env` directly
- ❌ Use `getDb()` with null checks (always returns initialized client)
- ❌ Forget to check `features.auth` before auth code

## Key Imports

```typescript
import { features } from '@/lib/features'; // Only auth & OAuth
import { env } from '@/lib/env';
import { db } from '@/lib/db'; // Always available
import { auth } from '@/lib/auth';
import logger from '@/lib/logger';
```

## Remember
**Database and Redis are required. Auth is optional.** This template requires PostgreSQL and Redis but makes auth/OAuth flexible.
